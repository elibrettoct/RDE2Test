%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% GRAMATICA - Abletech Limited
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

i_version( abletech_nz, `03 October 2013` ).

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% i_pdf_parameter( space, 2 ).
% i_pdf_parameter( tab, 10 ).
% i_pdf_parameter( new_line, 6 ).
% i_pdf_parameter( font_size, 30 ).  
% i_pdf_parameter( max_pages, 1 ).
EQWEQWEQWEQWEQE
i_date_format( _ ).

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
i_rule_list( [
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

	 get_buyer_details	

	, [ q0n(line), invoice_or_credit_note_line ]	

	, currency(`NZD`)
KL//
	, get_delivery_address
	
	, header_sample

	, invoice_number_line 
	
	, credit_number_line
	
	, [ q0n(line), terms_line ]
	
	, invoice_date_line	
	
	, [ q0n(line), due_date ]	

	, [ q0n(line), buyer_contact_line ]	
	
	, [ q0n(line), get_vat_number ]	
	
	, get_invoice_lines	

	, get_invoice_totals		

	, supplier_party( `Abletech Ltd.`)

	, supplier_contact(`Abletech Limited`)
	
	, supplier_street(`PO Box 25-346, Panama Street`)

	, supplier_city(`Wellington`)

	, supplier_postcode(`6146`)
	
	, order_number(``)

] ).


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% DELIVERY ADDRESS
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%=======================================================================
i_rule( get_delivery_address, [ 
%=======================================================================

	q0n(line)

	, delivery_start_line

	, q(0,3,line)

	, delivery_party_line

	, qn0( [ peek_fails(delivery_end_line)

		, or([ delivery_address_line, line]) ])

	, [ peek_fails(delivery_end_line), delivery_city_line ]

	, q0n(line)

	, delivery_end_line

] ).


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
i_line_rule( delivery_start_line, [
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

	q0n(anything)

	, read_ahead(delivery_left_margin)

	, `ship`, `to`, `:`, newline

] ).


%=======================================================================
i_line_rule( delivery_end_line, [ 
%=======================================================================

	`qty`, `stock`, tab

]).


%=======================================================================
i_line_rule( delivery_party_line, [ 
%=======================================================================

	nearest_word( delivery_left_margin(start), 30, 30 )

	, read_ahead([ `q`, `catering`])

	, delivery_party(s1), newline

	, trace( [ `delivery party`, delivery_party ] ) 

] ).


%=======================================================================
i_line_rule( delivery_address_line, [ 
%=======================================================================

	nearest_word( delivery_left_margin(start), 30, 30 )

	, delivery_address_line(s1), newline

	, trace( [ `delivery address`, delivery_address_line ] ) 


] ).


%=======================================================================
i_line_rule( delivery_city_line, [ 
%=======================================================================

	nearest_word( delivery_left_margin(start), 30, 30 )

	, q10([ delivery_city(s)

	, trace( [ `delivery city`, delivery_city ] ) ])

	, delivery_state(f([begin, q(alpha,2,3) ,end ])) 

	, trace( [ `delivery state`, delivery_state ] )

	, q10([delivery_postcode(f([begin, q(dec,4,4) ,end ])) ])

	, trace( [ `delivery postcode`, delivery_postcode ] ) 

	, newline

] ).




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% BUYER DETAILS
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%=======================================================================
i_rule( get_buyer_details, [ 
%=======================================================================

	 q0n(line)

	, buyer_header_line

	, q(0,3,line)

	, buyer_details_line	

] ).


%=======================================================================
i_line_rule( buyer_header_line, [ 
%=======================================================================

	or([[`TAX`, `INVOICE`, tab],[`CREDIT`, `NOTE`, tab]])

] ).


%=======================================================================
i_line_rule_cut( buyer_details_line, [ 
%=======================================================================

	or([ [`Converga`, buyer_party(`Converga Group `), buyer_registration_number(`110270471`) ]

	, [`Express`, `Couriers`, buyer_party(`Express Couriers Limited`), buyer_registration_number(`87519465`) ]
	
	, [`New`, `Zealand`, `Post`, buyer_party(`New Zealand Post Limited`), buyer_registration_number(`27351767`) ]
	
	, [`Kiwibank`, `Limited`, buyer_party(`Kiwibank Limited`), buyer_registration_number(`79167495`) ]
	
	, [`Reach`, `Media`, buyer_party(`Reach Media NZ Limited`), buyer_registration_number(`98164122`) ]
	
	, [`Air`, `Post`, buyer_party(`Air Post`), buyer_registration_number(`53688799`) ]
	
	, [`Recycling`, `Centre`, buyer_party(`Recycling Centre`), buyer_registration_number(`71922103`) ]
	
	, [`Kiwi`, `Insurance`, buyer_party(`Kiwi Insurance Ltd`), buyer_registration_number(`83309474`) ]
	
	, [`Kiwibank`, `Investment`, buyer_party(`Kiwibank Investment Management Ltd`), buyer_registration_number(`99409142`) ]
	
	, [`Localist`, `Ltd`, buyer_party(`Localist Ltd`), buyer_registration_number(`105175647`) ]
	
	, [`Datam`, `Limited`, buyer_party(`Datam Limited`), buyer_registration_number(`49070870`) ]
	
	])

	, trace( [ `buyer party`, buyer_party ] )

	, trace( [ `buyer registration number`, buyer_registration_number ] )

] ).


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% INVOICE OR CREDIT NOTE
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%=======================================================================
i_line_rule_cut( invoice_or_credit_note_line, [
%=======================================================================

	q0n(anything)

	, or( [
		[ `TAX`, `INVOICE`, tab, trace( [ `this is an invoice` ] ) ]

		, [ `CREDIT`, `NOTE`, tab, set(credit_note), trace( [ `this is a credit note` ] ) ]
	] )
] ).


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% VAT NUMBER
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%=======================================================================
i_line_rule( get_vat_number, [
%=======================================================================
	
	 supplier_vat_number(`105006861`)

	, supplier_registration_number(`105006861`)

	, trace( [`vat number`, supplier_vat_number]) 
	
] ).


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% INVOICE NUMBER
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%=======================================================================
i_rule( invoice_number_line, [
%=======================================================================

	[q0n(line), get_invoice_header_line]

	, [q0n(line), get_invoice_number_line]

] ).


%=======================================================================
i_line_rule( get_invoice_header_line, [ 
%=======================================================================

	read_ahead(in_anchor), `Invoice`, `Number`, tab
	
] ).


%=======================================================================
i_line_rule( get_invoice_number_line, [ 
%=======================================================================

	nearest_word(in_anchor(start), 0, 100)
	
	, invoice_number(s1) , or([[tab],[newline]])

	, trace( [ `invoice number`, invoice_number ] )

] ).

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% CREDIT NOTE NUMBER
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%=======================================================================
i_rule( credit_number_line, [
%=======================================================================

	[q0n(line), get_credit_header_line]

	, [q0n(line), get_credit_number_line]

] ).


%=======================================================================
i_line_rule( get_credit_header_line, [ 
%=======================================================================

	
	q0n(anything), read_ahead(cr_anchor), `Credit`, `Note`, `Number`,  newline
	
] ).


%=======================================================================
i_line_rule( get_credit_number_line, [ 
%=======================================================================

	nearest_word(cr_anchor(start), 0, 100)
	
	, invoice_number(s1) , or([[tab],[newline]])

	, trace( [ `invoice number`, invoice_number ] )

] ).


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% TERMS
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%=======================================================================
i_line_rule( terms_line, [ 
%=======================================================================

	q0n(anything)

	,`TERMS`, tab
	
	, payment_terms(s1), or([tab,newline])

	, trace( [ `payment terms`, payment_terms ] )


] ).


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% INVOICE DATE
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%=======================================================================
i_rule( invoice_date_line, [
%=======================================================================

	[q0n(line), get_date_header_line]

	, [q0n(line), get_date_line]

] ).


%=======================================================================
i_line_rule( get_date_header_line, [ 
%=======================================================================
	
	read_ahead(date_anchor), or([[`Invoice`, `Date`, tab],[`Date`, tab]])

] ).


%=======================================================================
i_line_rule( get_date_line, [ 
%=======================================================================

	nearest_word(date_anchor(start), 0, 100)

	, invoice_date(date) , tab

	, trace( [ `invoice date`, invoice_date ] )

] ).


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% ORDER NUMBER
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%=======================================================================
i_line_rule( order_number, [ 
%=======================================================================

	q0n(anything)

	, `order`, `number`, or([`#`,tab])
	
	, order_number(s1), q0n(anything), or([newline, tab])

	, trace( [ `order number`, order_number ] )

] ).


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% DUE DATE
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%=======================================================================
i_line_rule( due_date, [ 
%=======================================================================

	`Due`, `Date`, `:`
	
	, due_date(date), newline

	, trace( [ `due date`, due_date ] )

] ).


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% BUYER CONTACT NAME
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%=======================================================================
i_line_rule( buyer_contact_line, [ 
%=======================================================================

	`Attention`, `:`
	
	, buyer_contact(s1), tab

	, trace( [ `buyer contact name`, buyer_contact ] )

] ).


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% ACCOUNT NUMBER
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%=======================================================================
i_line_rule( account_number_line, [ 
%=======================================================================

	q0n(anything)

	, `Account`, `No`, tab
	
	, suppliers_code_for_buyer(s1), newline

	, trace( [ `account number`, suppliers_code_for_buyer ] )

] ).


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% GET TOTALS
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%=======================================================================
i_rule( get_invoice_totals, [
%=======================================================================

	[q0n(line), total_net_line]  	
	
	, [q0n(line), total_vat_line]	
	
	, [q0n(line), total_invoice_line]

] ).


%=======================================================================
i_line_rule( total_net_line, [
%=======================================================================

	`Subtotal`, q10(dummy(s1)), tab
	
	, total_net, newline

	, trace( [ `total net`, total_net ] )
	
] ).

%=======================================================================
i_line_rule( total_vat_line, [
%=======================================================================

	`TOTAL`, `GST`, `15`, `%`, tab

	, total_vat, newline

	, trace( [ `total vat`, total_vat ] )

] ).

%=======================================================================
i_line_rule( total_invoice_line, [
%=======================================================================
	
	`TOTAL`, `NZD`, tab

	, total_invoice, newline

	, trace( [ `total invoice`, total_invoice ] )	

] ).

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% GET LINES
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%=======================================================================
i_section( get_invoice_lines, [
%=======================================================================

	line_header_line

	, qn0( [ peek_fails(line_end_line)

		, or([  get_line_invoice, line
		
			])

		] )

] ).

%=======================================================================
i_line_rule_cut( line_header_line, [ 
%=======================================================================

	`Description`, tab, `Quantity`

] ).

%=======================================================================
i_line_rule( line_end_line, [ 
%=======================================================================

	or([
	[`Description`, tab, `Quantity`]
	, [`Subtotal`]
	
	])

] ).

%=======================================================================
i_line_rule_cut( get_line_invoice, [
%=======================================================================
	
	generic_item_cut( [ line_descr, s1, tab ] )
	
	, generic_item_cut( [ line_quantity, d, tab ] )
	
	, generic_item_cut( [ line_unit_amount, d, tab ] )
	
	, q10(generic_item_cut( [ line_percent_discount, d, tab ] ))
	
	, generic_item_cut( [ line_net_amount, d, newline ] )
	
	, line_vat_rate(`15`)

] ).

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
i_rule_cut( lookup_vat_rate, [
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

	q0n(line)

	, vat_table_header_line

	, q0n([ peek_fails(vat_table_end_line), line])

	, vat_table_lookup
	
] ).


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
i_line_rule_cut( vat_table_lookup, [
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

	lookup_code(w)

	, check( i_user_check( gen_same, lookup_code, local_line_vat_code) )

	, tab, goods(d), tab, line_vat_rate(d) 

	, trace([`Vat Rate` , line_vat_rate])

] ).


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
i_rule( read_amount_and_set_sign( [ NAME ] ), [
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

or( [
        [ test(credit_note), NEGATIVE_READ ]

        , [ peek_fails( test(credit_note)), NORMAL_READ ] 


  ] )
] )

:-

 NORMAL_READ =.. [ NAME, d ]

 , NEGATIVE_READ =.. [ NAME, n ]

. %end%



